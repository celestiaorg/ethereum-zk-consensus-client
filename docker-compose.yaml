services:
  celestia-init:
    image: ghcr.io/celestiaorg/celestia-app-standalone:feature-zk-execution-ism
    container_name: celestia-init
    entrypoint: /scripts/init.sh
    volumes:
      - ./testnet/celestia-app/init.sh:/scripts/init.sh:ro
      - celestia-app:/home/celestia/.celestia-app
    restart: "no"
    networks:
      - celestia-zkevm-net

  celestia-validator:
    image: ghcr.io/celestiaorg/celestia-app-standalone:feature-zk-execution-ism
    container_name: celestia-validator
    ports:
      - "26656:26656"
      - "26657:26657"
      - "1317:1317"
      - "9090:9090"
    healthcheck:
      test: [
        "CMD-SHELL",
        "bh=$(curl -sf http://localhost:26657/status | jq -r '.result.sync_info.latest_block_height'); if [ \"$$bh\" -gt 1 ]; then exit 0; else exit 1; fi"
      ]
      interval: 30s
      timeout: 5s
      start_period: 10s
    volumes:
      - celestia-app:/home/celestia/.celestia-app
    command: >
      start --force-no-bbr
    depends_on:
      celestia-init:
        condition: service_completed_successfully
    networks:
      - celestia-zkevm-net

  reth:
    image: ghcr.io/paradigmxyz/reth:latest
    container_name: reth
    networks:
      - celestia-zkevm-net
    ports:
      - "8545:8545"
      - "8551:8551"
      - "30303:30303"
    volumes:
      - ./reth-data:/data
      - ./jwt.hex:/config/jwt.hex:ro
      - ./genesis.json:/config/genesis.json:ro
    entrypoint: /bin/sh -c
    command: |
      reth node \
        --chain /config/genesis.json \
        --datadir /data \
        --http \
        --http.addr 0.0.0.0 \
        --http.port 8545 \
        --http.api eth,net,web3,debug \
        --ws \
        --ws.addr 0.0.0.0 \
        --ws.port 8546 \
        --authrpc.addr 0.0.0.0 \
        --authrpc.port 8551 \
        --authrpc.jwtsecret /config/jwt.hex \
        --metrics 0.0.0.0:9001

  prysm-beacon:
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:latest
    container_name: prysm-beacon
    depends_on:
      reth:
        condition: service_started
    networks:
      - celestia-zkevm-net
    ports:
      - "3500:3500"
      - "4000:4000"
    volumes:
      - prysm-data:/data
      - ./jwt.hex:/config/jwt.hex:ro
    command: >
      --accept-terms-of-use
      --datadir=/data
      --execution-endpoint=http://reth:8551
      --jwt-secret=/config/jwt.hex
      --rpc-host=0.0.0.0
      --grpc-gateway-host=0.0.0.0
      --grpc-gateway-port=3500
      --monitoring-host=0.0.0.0
      --checkpoint-sync-url=https://mainnet.checkpoint.sigp.io

volumes:
  celestia-app:
  prysm-data:

networks:
  celestia-zkevm-net:
    driver: bridge
